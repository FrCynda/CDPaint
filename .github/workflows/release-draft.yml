name: Draft Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  TAURI_CLI_VERSION: "2.10.0"

concurrency:
  group: draft-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-gate:
    name: Release Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate CHANGES_PENDING.md
        shell: bash
        run: |
          test -f CHANGES_PENDING.md || { echo "CHANGES_PENDING.md is required for releases."; exit 1; }

          for heading in "## Changes" "## Additions" "## Bug Fixes"; do
            grep -q "^${heading}$" CHANGES_PENDING.md || { echo "Missing section: ${heading}"; exit 1; }
          done

          changes_count=$(awk '/^## Changes$/{f=1;next}/^## /{f=0}f && /^- /{c++}END{print c+0}' CHANGES_PENDING.md)
          additions_count=$(awk '/^## Additions$/{f=1;next}/^## /{f=0}f && /^- /{c++}END{print c+0}' CHANGES_PENDING.md)
          bugfix_count=$(awk '/^## Bug Fixes$/{f=1;next}/^## /{f=0}f && /^- /{c++}END{print c+0}' CHANGES_PENDING.md)

          if [ "$changes_count" -eq 0 ] && [ "$additions_count" -eq 0 ] && [ "$bugfix_count" -eq 0 ]; then
            echo "CHANGES_PENDING.md has no categorized entries."
            exit 1
          fi

          current_tag="${GITHUB_REF_NAME}"
          last_tag=$(sed -n 's/^- Last tag release: `\(.*\)`/\1/p' CHANGES_PENDING.md | head -n1)
          if [ -n "$last_tag" ] && [ "$last_tag" = "$current_tag" ]; then
            echo "CHANGES_PENDING.md baseline still matches current release tag (${current_tag})."
            echo "It should describe changes leading up to this tag, not already be reset."
            exit 1
          fi

  draft-release:
    needs: release-gate
    name: Draft (${{ matrix.platform }})
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
          - platform: windows-latest
          - platform: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install frontend dependencies
        run: npm ci

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust artifacts
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            src-tauri -> target

      - name: Install Linux build dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libssl-dev \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            libsoup-3.0-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
          || sudo apt-get install -y \
            pkg-config \
            libssl-dev \
            libglib2.0-dev \
            libwebkit2gtk-4.0-dev \
            libgtk-3-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked --version "${{ env.TAURI_CLI_VERSION }}"

      - name: Build and upload draft release assets
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: src-tauri
          tagName: ${{ github.ref_name }}
          releaseName: "CDPaint ${{ github.ref_name }}"
          releaseDraft: true
          prerelease: false
          includeDebug: false
          includeRelease: true
          releaseBody: |
            Automated draft release for ${{ github.ref_name }}.
            Edit this draft before publishing.

  rename-assets:
    name: Rename Release Assets
    runs-on: ubuntu-latest
    needs: draft-release
    steps:
      - name: Rename assets to readable versioned names
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = context.ref.replace('refs/tags/', '');

            const rel = await github.rest.repos.getReleaseByTag({
              owner,
              repo,
              tag
            });

            const assets = rel.data.assets || [];

            function desiredName(name) {
              const lower = name.toLowerCase();
              if (lower.endsWith('.rpm')) return `CDPaint-${tag}-Linux-rpm-x64.rpm`;
              if (lower.endsWith('.appimage')) return `CDPaint-${tag}-Linux-AppImage-x64.AppImage`;
              if (lower.endsWith('.deb')) return `CDPaint-${tag}-Linux-deb-x64.deb`;
              if (lower.endsWith('-setup.exe') || lower.endsWith('.exe')) return `CDPaint-${tag}-Windows-Setup-x64.exe`;
              if (lower.endsWith('.msi')) return `CDPaint-${tag}-Windows-Installer-x64.msi`;
              if (lower.endsWith('.dmg')) {
                if (lower.includes('aarch64') || lower.includes('arm64')) return `CDPaint-${tag}-macOS-dmg-AppleSilicon.dmg`;
                return `CDPaint-${tag}-macOS-dmg-x64.dmg`;
              }
              if (lower.endsWith('.app.tar.gz')) {
                if (lower.includes('aarch64') || lower.includes('arm64')) return `CDPaint-${tag}-macOS-app-archive-AppleSilicon.tar.gz`;
                return `CDPaint-${tag}-macOS-app-archive-x64.tar.gz`;
              }
              return null;
            }

            const occupied = new Set(assets.map(a => a.name));

            for (const asset of assets) {
              const target = desiredName(asset.name);
              if (!target) continue;
              if (asset.name === target) continue;
              if (occupied.has(target)) {
                core.warning(`Skipping rename for ${asset.name}; target already exists: ${target}`);
                continue;
              }
              await github.rest.repos.updateReleaseAsset({
                owner,
                repo,
                asset_id: asset.id,
                name: target
              });
              core.info(`Renamed ${asset.name} -> ${target}`);
              occupied.delete(asset.name);
              occupied.add(target);
            }
